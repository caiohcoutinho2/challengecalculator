<!DOCTYPE html>
<html lang="en" ng-app='myApp' ng-controller='calc'>
<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <style TYPE="text/css">
        input{
        width: 100px;
        margin: 3px;
        }

        table.bordered td{
            border-style: solid;
            border-width: 1px;
        }
    </style>
    <title>Calculadora de desafio</title>
</head>
<body>
<h1>Calculadora de desafio</h1>
<h3 ng-click="addHero()">Adicionar her√≥i</h3>
<h3 ng-click="addEnemy()">Adicionar inimigo</h3>

<table>
    <tr>
        <td>
            <table class="bordered">
                <tr ng-repeat="hero in heroes">
                    <td>
                        NH: <input type="number" ng-model="hero.nh"/> {{100*test(hero.nh) | number: 2}}% <br>
                        Defesa Ativa: <input type="number" ng-model="hero.defense"/> {{100*(test(hero.defense)) | number: 2}}% <br>
                        Dano: <input type="number" ng-model="hero.dice"/>d +<input type="number" ng-model="hero.bonus"/> {{averageDamage(hero.dice, hero.bonus)}}<br>
                        RD: <input type="number" ng-model="hero.rd"/><br>
                    </td>
                </tr>
            </table>
        </td>
        <td>
            <table class="bordered">
                <tr ng-repeat="enemy in enemies">
                    <td>
                        NH: <input type="number" ng-model="enemy.nh"/> {{100*test(enemy.nh) | number: 2}}% <br>
                        Defesa Ativa: <input type="number" ng-model="enemy.defense"/> {{100*(test(enemy.defense)) | number: 2}}% <br>
                        Dano: <input type="number" ng-model="enemy.dice"/>d +<input type="number" ng-model="enemy.bonus"/> {{averageDamage(enemy.dice, enemy.bonus)}}<br>
                        RD: <input type="number" ng-model="enemy.rd"/><br>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>


<!--
Chance de acertar: {{100*toHit(nh, defense) | number: 2}}% <br>
Chance de danificar: {{100*toDamage(nh, defense, dice, bonus, rd) | number: 2}}%
-->

</body>
<script>
	var app = angular.module('myApp', []);
	app.controller('calc', ['$scope', function($scope){

	    $scope.heroes = [];
	    $scope.enemies = [];

	    var addHero = function(){
	        $scope.heroes.push({});
	    }

	    var addEnemy = function(){
	        $scope.enemies.push({});
	    }

		var averageDamage = function(dice, bonus){
			return expect(dice)+ (bonus || 0);
		};

		var test = function(nh){
			var per = acumulate(nh, 3);
			return per > 0? per: 0;
		}

		var expectMap = [3.5,7,10.5,14,17.5,21,24.5,28,31.5]

		var expect = function(dice, bonus){
		    if(dice != null && dice > 0){
		        var result = expectMap[dice-1];
		        if(bonus != null){
		            result += bonus;
		        }
		        return result;
		    }
			return 0;
		}

		var acumulate = function(target, dice){
		    if(target == null || dice == null || target < 1 || dice < 1){
		        return 0;
		    }
		    if(target > 64 || dice > 9){
		        var msg = 'chance limit excceded: '+target+' '+dice;
		        alert(msg);
		        throw new Error(msg);
		    }
		    var sum = 0;
		    for( var i = 1 ; i <= target ; i++){
		        sum += chanceMap[i-1][dice-1];
		    }
		    return sum;
		};

		var toHit = function(nh, defense){
		    var crit = acumulate(3, 3);
		    var nonCrit = acumulate(nh, 3) - crit;
		    nonCrit = nonCrit > 0? nonCrit : 0;
		    var def = acumulate(defense, 3);
		    var hit = crit+nonCrit*(1-def);
		    return hit;
		};

		var toDamage = function(nh, defense, dice, bonus, rd){
		    if(dice == null || dice <= 0){
		        return 0;
		    }
		    return toHit(nh, defense)*(1-acumulate(rd-bonus, dice));
		};

		var chanceMap =[[0.16666667,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.02777778,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.05555556,0.00462963,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.08333333,0.01388889,0.00077160,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.11111111,0.02777778,0.00308642,0.00012860,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.13888889,0.04629630,0.00771605,0.00064300,0.00002143,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.16666667,0.06944444,0.01543210,0.00192901,0.00012860,0.00000357,0.00000000,0.00000000],
                        [0.00000000,0.13888889,0.09722222,0.02700617,0.00450103,0.00045010,0.00002501,0.00000060,0.00000000],
                        [0.00000000,0.11111111,0.11574074,0.04320988,0.00900206,0.00120027,0.00010002,0.00000476,0.00000010],
                        [0.00000000,0.08333333,0.12500000,0.06172840,0.01620370,0.00270062,0.00030007,0.00002143,0.00000089],
                        [0.00000000,0.05555556,0.12500000,0.08024691,0.02636317,0.00540123,0.00075017,0.00007144,0.00000447],
                        [0.00000000,0.02777778,0.11574074,0.09645062,0.03922325,0.00977366,0.00165038,0.00019647,0.00001637],
                        [0.00000000,0.00000000,0.09722222,0.10802469,0.05401235,0.01620370,0.00327575,0.00047154,0.00004912],
                        [0.00000000,0.00000000,0.06944444,0.11265432,0.06944444,0.02488426,0.00595493,0.00101690,0.00012771],
                        [0.00000000,0.00000000,0.04629630,0.10802469,0.08371914,0.03570816,0.01002729,0.00200522,0.00029709],
                        [0.00000000,0.00000000,0.02777778,0.09645062,0.09452160,0.04816101,0.01577861,0.00365977,0.00063050],
                        [0.00000000,0.00000000,0.01388889,0.08024691,0.10030864,0.06121399,0.02335534,0.00623952,0.00123689],
                        [0.00000000,0.00000000,0.00462963,0.06172840,0.10030864,0.07353824,0.03265746,0.01000705,0.00226490],
                        [0.00000000,0.00000000,0.00000000,0.04320988,0.09452160,0.08371914,0.04328489,0.01517490,0.00390000],
                        [0.00000000,0.00000000,0.00000000,0.02700617,0.08371914,0.09047068,0.05453747,0.02184309,0.00635056],
                        [0.00000000,0.00000000,0.00000000,0.01543210,0.06944444,0.09284979,0.06546854,0.02994018,0.00982159],
                        [0.00000000,0.00000000,0.00000000,0.00771605,0.05401235,0.09047068,0.07499214,0.03918038,0.01447742],
                        [0.00000000,0.00000000,0.00000000,0.00308642,0.03922325,0.08371914,0.08204375,0.04904931,0.02039752],
                        [0.00000000,0.00000000,0.00000000,0.00077160,0.02636317,0.07353824,0.08579461,0.05883071,0.02753248],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.01620370,0.06121399,0.08579461,0.06768690,0.03566976],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00900206,0.04816101,0.08204375,0.07477185,0.04442176],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00450103,0.03570816,0.07499214,0.07935623,0.05324322],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00192901,0.02488426,0.06546854,0.08094350,0.06147923],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00064300,0.01620370,0.05453747,0.07935623,0.06843975],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00012860,0.00977366,0.04328489,0.07477185,0.07349091],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00540123,0.03265746,0.06768690,0.07614776],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00270062,0.02335534,0.05883071,0.07614776],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00120027,0.01577861,0.04904931,0.07349091],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00045010,0.01002729,0.03918038,0.06843975],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00012860,0.00595493,0.02994018,0.06147923],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002143,0.00327575,0.02184309,0.05324322],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00165038,0.01517490,0.04442176],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00075017,0.01000705,0.03566976],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00030007,0.00623952,0.02753248],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00010002,0.00365977,0.02039752],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002501,0.00200522,0.01447742],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000357,0.00101690,0.00982159],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00047154,0.00635056],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00019647,0.00390000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00007144,0.00226490],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002143,0.00123689],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000476,0.00063050],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000060,0.00029709],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00012771],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00004912],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00001637],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000447],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000089],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000010],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000]];

		$scope.test = test;
		$scope.averageDamage  = averageDamage;
		$scope.toHit = toHit;
		$scope.toDamage = toDamage;
		$scope.addHero = addHero;
		$scope.addEnemy = addEnemy;
	}]);
    </script>
</html>