<!DOCTYPE html>
<html lang="en" ng-app='myApp' ng-controller='calc'>
<head>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.16/clipboard.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
    <!--
        red rgb(228,95,86)
        green rgb(163,211,156)
        light blue rgb(122,204,200)
        darg green rgb(74,170,165)
        dark blud rgb(53,64,79)
    -->
    <style TYPE="text/css">

        nav.navbar{
            background-color: rgb(122,204,200);
        }

        table table.table.fundoVerde{
            background-color: rgb(163,211,156);
            border-collapse: separate;
            border-spacing: 0px 34px;   
        }

        body{
            background-color: rgb(163,211,156);
            color: rgb(53,64,79);
        }

        td.tdPanel{
            background-color: rgb(122,204,200);
            padding: 20px;
        }

        table.loginTable{
            margin-left: auto;
            margin-right: auto;
            margin-top: 100px;
            border-collapse: separate;
            border-spacing: 34px;
        }

        table.separated{
            border-collapse: separate;
            border-spacing: 34px;   
        }

        .rounded{
            background-color: rgb(122,204,200);
            border-radius: 10px;
            padding: 10px;
            border-spacing: 10px;
            border-color: rgb(74,170,165);
            border-style: solid;
            border-width: 2px;
        }

        .jsonfont{
            font-size: small;
        }

        table.loginTable div.form-group{
            margin-bottom: -20px;
        }

        table.characterTable input[type=number]{
            width: 50px;
        }

        td.bordered{
            width: 50%
        }

        table.tabelaInternaInimigo{
            border-collapse: separate; 
            border-spacing: 10px 0px;
        }

        td.linhaInimigo{
            background-color: rgb(122,204,200);
            border-radius: 10px;
            padding: 10px;
            border-spacing: 10px;
            border-color: rgb(74,170,165);
            border-style: solid;
            border-width: 2px;
        }

        .big{
            font-size: x-large;
        }

        .red{
            color: red
        }

        .green{
            color: green
        }

        .yellow{
            color: orange
        }
    </style>
    <title>Calculadora de desafio</title>
</head>
<body>
<div ng-show="loggedIn">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <span class="navbar-brand">Challenge Calculator</span>
            </div>
            <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Opções <span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li><a href="#" ng-click="setDefaultMode()">Cadastro de personagens</a></li>
                    <li><a href="#" ng-click="setSimulationMode()">Simulação de combate</a></li>
                  </ul>
                </li>
            </ul>
              <form class="navbar-form navbar-left">
                <button type="submit" ng-click="save()" class="btn btn-default">
                    <span class="glyphicon glyphicon-save" aria-hidden="true"></span>Salvar
                </button>
                <button type="submit" ng-click="addEnemy()" class="btn btn-default">
                    Adicionar inimigo
                </button>
                <button type="submit" ng-click="addHero()" class="btn btn-default">
                    Adicionar herói
                </button>
                Redutor de defesa: <input min="0" style="width: 50px" type="number" ng-model="reduction"/>
                Ignora RD? <input type="checkbox" style="width: 20px" ng-model="ignoreRD"/>
              </form>
              <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" ng-click="logOut()">Logout</a>
                </li>
              </ul>
            </div>
        </div>
    </nav>

    <div ng-show="isSimulationMode">
        <table class="table">
            <tr>
                <td class="col-sm-2 tdPanel">
                    <form class="form">
                        <table class="table">
                            <tr class="row">
                                <td>
                                  <div class="form-group">
                                    <label for="selectEnemy">Inimigo</label>
                                    <select ng-model="battleEnemy" class="form-control">
                                        <option ng-repeat="enemy in enemies" value="{{$index}}">{{enemy.name}}</option>
                                    </select>
                                  </div>
                              </td>
                            </tr> 
                            <tr class="row">
                                <td>
                                  <div class="form-group">
                                    <label for="enemyDamageMultiplier">Multiplicador de ferimento sofrido pelo inimigo</label>
                                    <input ng-model="enemyWoundsModifier" min="0" style="width: 75px;" type="number" step="0.1" class="form-control" id="enemyDamageMultiplier">
                                  </div>
                                </td>
                            </tr>
                            <tr class="row">
                                <td>
                                  <div class="form-group">
                                    <label for="selectEnemy">Herói</label>
                                    <select ng-model="battleHero" class="form-control">
                                        <option ng-repeat="hero in heroes" value="{{$index}}">{{hero.name}}</option>
                                    </select>
                                  </div>
                                </td>
                            </tr>
                            <tr class="row">
                                <td>
                                  <div class="form-group">
                                    <label for="heroDamageMultiplier">Multiplicador de ferimento sofrido pelo herói</label>
                                    <input ng-model="heroWoundsModifier" min="0" style="width: 75px;" type="number" step="0.1" class="form-control" id="eheroamageMultiplier">
                                  </div>
                                </td>
                            </tr>
                            <tr class="row">
                                <td>
                                  <button class="btn btn-sm btn-success" ng-click="simulate()">Simular!</button>
                                </td>
                            </tr>
                        </table>
                    </form>
                </td>
                <td class="col-sm-10">
                    <table class="table tdPanel">
                        <tr class="row" ng-repeat="log in logs">
                            <td class="col-sm-10">
                                <span>{{log.text}}</span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
    <div ng-show="isDefaultMode">
        <table class="table">
            <tr class="row">
                <td class="col-sm-6">
                    <h3>Inimigos</h3>
                    <table class="fundoVerde table" style="overflow-y: auto; width: 100%; display: block;">
                        <tr ng-repeat="enemy in enemies">
                            <td class="linhaInimigo">
                                <table class="tabelaInternaInimigo">
                                    <td>
                                        <table class="table characterTable">
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">Nome:</td>
                                                <td colspan="1" class="col-sm-10"><input type="text" ng-model="enemy.name"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">NH:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" ng-model="enemy.nh"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">Defesa Ativa:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" ng-model="enemy.defense"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">Dano:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" ng-model="enemy.dice"/>d +<input type="number" ng-model="enemy.bonus"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">RD:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" ng-model="enemy.rd"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">PV:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" ng-model="enemy.hp"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">Velocidade:</td>
                                                <td colspan="1" class="col-sm-10"><input type="number" step="0.1" ng-model="enemy.speed"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="1" class="left col-sm-2">Quantidade:</td>
                                                <td colspan="1" class="col-sm-10"><input min="1" type="number" ng-model="enemy.number"/></td>
                                            </tr>
                                            <tr class="row">
                                                <td colspan="2" class="col-sm-12" style="text-align: center;">
                                                    <button class="btn btn-sm btn-default" title="Remover" ng-click="removeEnemy($index)">
                                                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default" title="Limpar" ng-click="clearEnemy($index)">
                                                        <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
                                                    </button>
                                                    <button class="btn btn-sm btn-default" title="Importar" ng-click="importEnemy($index)">
                                                        <span class="glyphicon glyphicon-paste" aria-hidden="true"></span>
                                                    </button>
                                                    <button data-clipboard-text="{{exportChar(enemy)}}" title="Exportar" class="clipboardButton btn btn-sm btn-default">
                                                        <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td class="">
                                        <table class="table" style="width: 100%; text-align: center">
                                            <tr>
                                                <th>Herói</th>
                                                <th>Chance do herói causar dano</th>
                                                <th>Dano médio causado ao inimigo</th>
                                                <th>Chance do inimigo causar dano</th>
                                                <th>Dano médio causado ao herói</th>
                                            </tr>
                                            <tr ng-repeat="hero in heroes" ng-show="isHeroValid(hero)">
                                                <td>{{hero.name}}</td>
                                                <td class="big" ng-class="calculateClass(true, statsAttack(enemy, $index))">{{statsAttack(enemy, $index) | number: 2}}%</td>
                                                <td class="big">{{statsAverageReceivedDamage(enemy, $index) | number: 2}}</td>
                                                <td class="big" ng-class="calculateClass(false, statsDefense(enemy, $index))">{{statsDefense(enemy, $index) | number: 2}}%</td>
                                                <td class="big">{{statsAverageDamage(enemy, $index) | number: 2}}</td>
                                            </tr>
                                            <tr>
                                                <td><b>MÉDIA</b></td>
                                                <td class="big" ng-class="calculateClass(true, statsAttack(enemy, 'total'))">{{enemy.stats.total.attack | number: 2}}%</td>
                                                <td class="big">{{statsAverageReceivedDamage(enemy, 'total') | number: 2}}</td>
                                                <td class="big" ng-class="calculateClass(false, statsDefense(enemy, 'total'))">{{enemy.stats.total.defense | number: 2}}%</td>
                                                <td class="big">{{statsAverageDamage(enemy, 'total') | number: 2}}</td>
                                            </tr>
                                        </table>
                                    </td>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
                <td class="col-sm-3">
                    <h3>Heróis</h3>
                    <table class="fundoVerde table" style="overflow-y: auto;  width: 100%; display: block;">
                        <tr class="" ng-repeat="hero in heroes">
                            <td class="linhaInimigo">
                                <table class="table characterTable">
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">Ativo:</td>
                                        <td colspan="1" class="col-sm-10"><input type="checkbox" ng-model="hero.active"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">Nome:</td>
                                        <td colspan="1" class="col-sm-10"><input type="text" ng-model="hero.name"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">NH:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" ng-model="hero.nh"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">Defesa Ativa:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" ng-model="hero.defense"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">Dano:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" ng-model="hero.dice"/>d +<input type="number" ng-model="hero.bonus"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">RD:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" ng-model="hero.rd"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">PV:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" ng-model="hero.hp"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="1" class="left col-sm-2">Velocidade:</td>
                                        <td colspan="1" class="col-sm-10"><input type="number" step="0.1" ng-model="hero.speed"/></td>
                                    </tr>
                                    <tr class="row">
                                        <td colspan="2" class="col-sm-12" style="text-align: center; ">
                                            <button class="btn btn-sm btn-default" title="Remover" ng-click="removeHero($index)">
                                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                            </button>
                                            <button class="btn btn-sm btn-default" title="Limpar" ng-click="clearHero($index)">
                                                <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
                                            </button>
                                            <button class="btn btn-sm btn-default" title="Importar" ng-click="importHero($index)">
                                                <span class="glyphicon glyphicon-paste" aria-hidden="true"></span>
                                            </button>
                                            <button data-clipboard-text="{{exportChar(hero)}}" title="Exportar" class="clipboardButton btn btn-sm btn-default">
                                                <span class="glyphicon glyphicon-copy" aria-hidden="true"></span>
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
</div>
<div ng-show="!loggedIn">
    <table class="loginTable" cellspacing="50px">
        <tr>
            <td class="rounded">
                <form class="form-horizontal">
                  <div class="form-group">
                    <label for="inputUsername" class="col-sm-4 control-label">Usuário</label>
                    <div class="col-sm-6">
                      <input type="text" maxlength="20" class="form-control" id="inputUsername" ng-model="username" placeholder="Usuário" maxlength="20">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="inputPassword" class="col-sm-4 control-label">Senha</label>
                    <div class="col-sm-6">
                      <input type="password" maxlength="20" class="form-control" id="inputPassword" placeholder="Senha" ng-model="password">
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-offset-4 col-sm-6">
                      <a class="btn btn-success" href="#" ng-click="logIn()">Acessar</a>
                    </div>
                  </div>
                </form>
            </td>
            <td class="rounded">
                <form class="form-horizontal">
                  <div class="form-group">
                    <label for="inputNewUsername" class="col-sm-4 control-label">Usuário</label>
                    <div class="col-sm-6">
                      <input type="text" maxlength="20" class="form-control" id="inputNewUsername" ng-model="newUsername" placeholder="Username" maxlength="20">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="inputNewPassword" class="col-sm-4 control-label">Senha</label>
                    <div class="col-sm-6">
                      <input type="password" maxlength="20" class="form-control" id="inputNewPassword" placeholder="Senha" ng-model="newPassword">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="inputConfirmPassword" class="col-sm-4 control-label">Confirme a senha</label>
                    <div class="col-sm-6">
                      <input type="password" maxlength="20" class="form-control" id="inputConfirmPassword" placeholder="Password" ng-model="confirmNewPassword">
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="col-sm-offset-4 col-sm-6">
                      <a class="btn btn-info" href="#" ng-click="newUser()">Inscrever</a>
                    </div>
                  </div>
                </form>
            </td>
        </tr>
    </table>
</div>
</body>
<script>
	var app = angular.module('myApp', []);
	app.controller('calc', ['$scope', '$http', function($scope, $http){

        var clipboard = new Clipboard(".clipboardButton");

        $scope.isDefaultMode = true;
        $scope.isSimulationMode = false;

        $scope.setDefaultMode = function(){
            $scope.isDefaultMode = true;
            $scope.isSimulationMode = false;            
        }
        $scope.setSimulationMode = function(){
            $scope.isDefaultMode = false;
            $scope.isSimulationMode = true;
        }

        clipboard.on('success', function(e) {
            alert("O Json foi copiado para sua área de transferência.\n"+e.text);
            e.clearSelection();
        });

        var transform = function(obj) {
            var str = [];
            for(var p in obj)
            str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            return str.join("&");
        }

        $scope.isHeroValid = function(h){
            return h.name != null && h.active;
        }

        $scope.loggedIn = false;

        $scope.save = function(){

            $http({
                method: 'POST',
                url: '/characters',
                headers: {'Content-Type': 'application/json; charset=UTF-8'},
                data: {
                    'username': $scope.username,
                    'reduction': $scope.reduction,
                    'ignoreRD': $scope.ignoreRD,
                    'heroes' : $scope.heroes,
                    'enemies' : $scope.enemies,
                },
            }).then(
                function(response){
                   if(response.status == 200){
                        alert("Sua coleção foi salva com sucesso!");
                   }
                },
                function(response){
                   if(response.status == 500){
                        alert(response.data.error);
                   }
                }
            );
        }

        $scope.newUser = function(){

            if($scope.newPassword != $scope.confirmNewPassword){
                alert("Passwords don't match.");
                return;
            }

            $http({
                method: 'POST',
                url: '/signup',
                headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
                transformRequest: transform,
                data: {
                    'username': $scope.newUsername,
                    'password': $scope.newPassword,
                },
            }).then(
                function(response){
                   if(response.status == 200){
                        $scope.loggedIn = true;
                        $scope.username = $scope.newUsername;
                        delete $scope.password;
                        delete $scope.newUsername;
                        delete $scope.newPassword;
                        delete $scope.confirmNewPassword;
                   }
                },
                function(response){
                   if(response.status == 500){
                        alert(response.data.error);
                   }
                }
            );
        }

        $scope.logIn = function(){

            $http({
                method: 'POST',
                url: '/login',
                headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
                transformRequest: transform,
                data: {
                    'username': $scope.username,
                    'password': $scope.password,
                },
            }).then(
                function(response){
                   if(response.status == 200){
                        $scope.loggedIn = true;
                        delete $scope.password;
                        delete $scope.newUsername;
                        delete $scope.newPassword;
                        delete $scope.confirmNewPassword;

                        $http({
                            method: 'GET',
                            url: '/characters',
                            headers: {'Content-Type': 'application/json; charset=UTF-8'},
                            params: {
                                'username': $scope.username
                            }
                        }).then(
                            function(res){
                                if(res.status == 200){
                                    var data = res.data;

                                    $scope.heroes = data.heroes || [];
                                    $scope.enemies = data.enemies || [];
                                    $scope.reduction = data.reduction;
                                    $scope.ignoreRD = data.ignoreRD;

                                    updateStats();
                                }
                            },
                            function(res){

                            }
                        )
                   }
                },
                function(response){
                   if(response.status == 500){
                        alert(response.data.error);
                   }
                }
            );
        }

        $scope.logOut = function(){
            delete $scope.username;
            delete $scope.password;
            delete $scope.newUsername;
            delete $scope.newPassword;
            delete $scope.confirmNewPassword;
            $scope.heroes = [];
            $scope.enemies = [];
            delete $scope.ignoreRD;
            delete $scope.reduction;
            $scope.loggedIn = false;
        }

        $scope.heroes = [];
        $scope.enemies = [];
        delete $scope.ignoreRD;
        delete $scope.reduction;

        var Log = function(i, text, isHero){
            this.index = i;
            this.text = text;
            this.isHero = isHero;
        }

        var roll1d6 = function(){
            return Math.floor(Math.random() * 6) + 1;
        }

        var roll3d6 = function(){
            var soma = 0;
            soma += roll1d6();
            soma += roll1d6();
            soma += roll1d6();
            return soma;
        }

        $scope.simulate = function(){
            var hero = $scope.heroes[$scope.battleHero];
            var enemy = $scope.enemies[$scope.battleEnemy];
            var heroWoundsModifier = $scope.heroWoundsModifier;
            var enemyWoundsModifier = $scope.enemyWoundsModifier;

            if(hero == null || enemy == null || heroWoundsModifier == null || enemyWoundsModifier == null){
                alert("Todos os campos são obrigatórios para a simulação.");
                return;
            }

            var logs = [];

            var i = 0;

            var heroMaxHP = hero.hp;
            var enemyMaxHP = enemy.hp;
            var heroNH = hero.nh;
            var enemyNH = enemy.nh;
            var heroDice = hero.dice;
            var enemyDice = enemy.dice;
            var heroBonus = hero.bonus;
            var enemyBonus = enemy.bonus;
            var heroRD = hero.rd;
            var enemyRD = enemy.rd;
            var heroSpeed = hero.speed;
            var enemySpeed = enemy.speed;
            var heroName = hero.name;
            var enemyName = enemy.name;
            var heroDefense = hero.defense;
            var enemyDefense = enemy.defense;

            var reduction = $scope.reduction;

            var ignoreRD = $scope.ignoreRD;

            if(heroMaxHP == null || heroMaxHP < 1){
                logs.push(new Log(i++, heroName+" não tem HP configurado. Vamos usar 10.", false));
                heroMaxHP = 10;
            }
            if(enemyMaxHP == null || enemyMaxHP < 1){
                logs.push(new Log(i++, enemyName+" não tem HP configurado. Vamos usar 10.", false));
                enemyMaxHP = 10;
            }
            if(heroSpeed == null || heroSpeed <= 0){
                logs.push(new Log(i++, heroName+" não tem velocidade configurada. Vamos usar 6.", false));
                heroSpeed = 6;
            }
            if(enemySpeed == null || enemySpeed <= 0){
                logs.push(new Log(i++, enemyName+" não tem velocidade configurada. Vamos usar 6.", false));
                enemySpeed = 6;
            }

            var heroHP = heroMaxHP;
            var enemyHP = enemyMaxHP;

            var isHeroTurn = false;
            if(enemySpeed == heroSpeed){
                logs.push(new Log(i++, "A velocidade de "+heroName+" é igual a velocidade de "+enemyName+". Vamos sortear quem vai primeiro.", false));
                isHeroTurn = Math.random() >= 0.5;
            } else{
                isHeroTurn = heroSpeed > enemySpeed;
            }

            if(isHeroTurn){
                logs.push(new Log(i++, heroName+" vai começar.", true));
            } else{
                logs.push(new Log(i++, enemyName+" vai começar.", false));
            }

            while( i < 500 ){
                if(isHeroTurn){
                    var testeNH = roll3d6();
                    if(testeNH == 3 || 
                        (testeNH == 4 && heroNH == 14) ||
                        (testeNH == 5 && heroNH == 15) || 
                        (testeNH == 6 && heroNH == 16)){
                        // Crit!
                        var damage = heroDice * 6 + heroBonus;
                        if(!ignoreRD){
                            damage -= enemyRD;
                        }
                        if(damage <= 0){
                            damage = 0;
                            logs.push(new Log(i++, heroName+" acertou um golpe crítico ("+testeNH+"/"+heroNH+")! Causou "+damage+" de dano, mas a resistência de "+enemyName+" é "+enemyRD+", então nenhum ferimento foi causado.", true)); 
                        } else{
                            enemyHP -= Math.floor(damage*enemyWoundsModifier);
                            logs.push(new Log(i++, heroName+" acertou um golpe crítico ("+testeNH+"/"+heroNH+")! Causou "+damage+" de dano ("+Math.floor(damage*enemyWoundsModifier)+" de ferimentos) e "+enemyName+" agora tem "+enemyHP+" PV restantes.", true));
                        }
                    } else{
                        if(testeNH >= 17 || testeNH > heroNH){
                            logs.push(new Log(i++, heroName+" errou o golpe ("+testeNH+"/"+heroNH+").", true));                             
                        } else{
                            var testeDefesa = roll3d6();
                            if(testeDefesa <= (enemyDefense-reduction)){
                                logs.push(new Log(i++, heroName+" tentou um golpe ("+testeNH+"/"+heroNH+") mas "+enemyName+" se defendeu ("+testeDefesa+"/"+(enemyDefense-reduction)+")", true));     
                            } else{
                                var damage = heroBonus;
                                for(var j = 0; j < heroDice; j++){
                                    damage += roll1d6();
                                }
                                if(!ignoreRD){
                                    damage -= enemyRD;
                                }
                                if(damage <= 0){
                                    damage = 0;
                                    logs.push(new Log(i++, heroName+" acertou um golpe ("+testeNH+"/"+heroNH+") e causou "+damage+" de dano. A resistência de "+enemyName+" é "+enemyRD+", então nenhum ferimento foi causado.", true)); 
                                } else{
                                    enemyHP -= Math.floor(damage*enemyWoundsModifier);
                                    logs.push(new Log(i++, heroName+" acertou um golpe ("+testeNH+"/"+heroNH+") e causou "+damage+" de dano ("+Math.floor(damage*enemyWoundsModifier)+" de ferimentos). "+enemyName+" agora tem "+enemyHP+" PV restantes.", true)); 
                                }
                            }
                        }
                    }
                    if(enemyHP <= 0){
                        logs.push(new Log(i++, enemyName+" foi derrotado! "+heroName+" ainda tem "+heroHP+" restantes.", true));
                        break;
                    }
                } else{
                    var testeNH = roll3d6();
                    if(testeNH == 3 || 
                        (testeNH == 4 && enemyNH == 14) ||
                        (testeNH == 5 && enemyNH == 15) || 
                        (testeNH == 6 && enemyNH == 16)){
                        // Crit!
                        var damage = enemyDice * 6 + enemyBonus;
                        if(!ignoreRD){
                            damage -= enemyRD;
                        }
                        if(damage <= 0){
                            damage = 0;
                            logs.push(new Log(i++, enemyName+" acertou um golpe crítico ("+testeNH+"/"+enemyNH+")! Causou "+damage+" de dano, mas a resistência de "+heroName+" é "+heroRD+", então nenhum ferimento foi causado.", false)); 
                        } else{
                            heroHP -= Math.floor(damage*heroWoundsModifier);
                            logs.push(new Log(i++, enemyName+" acertou um golpe crítico ("+testeNH+"/"+enemyNH+")! Causou "+damage+" de dano ("+Math.floor(damage*enemyWoundsModifier)+" de ferimentos) e "+heroName+" agora tem "+heroHP+" PV restantes.", false));
                        }
                    } else{
                        if(testeNH >= 17 || testeNH > enemyNH){
                            logs.push(new Log(i++, enemyName+" errou o golpe ("+testeNH+"/"+enemyNH+").", false));         
                        } else{
                            var testeDefesa = roll3d6();
                            if(testeDefesa <= (heroDefense-reduction)){
                                logs.push(new Log(i++, enemyName+" tentou um golpe ("+testeNH+"/"+enemyNH+") mas "+heroName+" se defendeu ("+testeDefesa+"/"+(heroDefense-reduction)+")", false));     
                            } else{
                                var damage = enemyBonus;
                                for(var j = 0; j < enemyDice; j++){
                                    damage += roll1d6();
                                }
                                if(!ignoreRD){
                                    damage -= enemyRD;
                                }
                                if(damage <= 0){
                                    damage = 0;
                                    logs.push(new Log(i++, enemyName+" acertou um golpe ("+testeNH+"/"+enemyNH+") e causou "+damage+" de dano. A resistência de "+heroName+" é "+heroRD+", então nenhum ferimento foi causado.", false)); 
                                } else{
                                    heroHP -= Math.floor(damage*heroWoundsModifier);
                                    logs.push(new Log(i++, enemyName+" acertou um golpe ("+testeNH+"/"+enemyNH+") e causou "+damage+" de dano ("+Math.floor(damage*enemyWoundsModifier)+" de ferimentos). "+heroName+" agora tem "+heroHP+" PV restantes.", false)); 
                                }
                            }
                        }
                    }
                    if(heroHP <= 0){
                        logs.push(new Log(i++, heroName+" foi derrotado! "+enemyName+" ainda tem "+enemyHP+" PV restantes.", false));
                        break;
                    }
                }
                isHeroTurn = !isHeroTurn;
            }

            if(i == 500){
                logs.push(new Log(i, "Chega dessa luta ...", false));
            }

            $scope.logs = logs;
        }
        
		var averageDamage = function(dice, bonus){
			return expect(dice)+ (bonus || 0);
		};

		var test = function(nh){
			var per = acumulate(nh, 3);
			return per > 0? per: 0;
		}

		var expectMap = [3.5,7,10.5,14,17.5,21,24.5,28,31.5]

		var expect = function(dice, bonus){
		    if(dice != null && dice > 0){
		        var result = expectMap[dice-1];
		        if(bonus != null){
		            result += bonus;
		        }
		        return result;
		    }
			return 0;
		}

		var updateStats = function(){
		    var enemies = $scope.enemies;
		    var heroes = $scope.heroes;
		    var reduction = $scope.reduction || 0;
            var ignoreRD = $scope.ignoreRD;
            var ignoreReceivedRD = $scope.ignoreRD;
            for(var i = 0; i < enemies.length; i++){
                var enemy = enemies[i];
                if(enemy.number < 1){
                    enemy.number = 1;
                }
                var attack = 0;
                var defense = 0;
                var averageDamage = 0;
                var averageReceivedDamage = 0;
                enemy.stats = {};
                var numberOfEnemies = enemy.number;
                var count = 0;
		        for(var j = 0; j < heroes.length; j++){
                    var hero = heroes[j];
                    if($scope.isHeroValid(hero)){
                        count++;
    		            var hAttack = 100*toDamage(hero.nh, enemy.defense, hero.dice, hero.bonus, enemy.rd);
    		            var hDefense = 100*(1-Math.pow(1-toDamage(enemy.nh, hero.defense - reduction, enemy.dice, enemy.bonus, hero.rd, ignoreRD), numberOfEnemies));
    		            var hAverageDamage = numberOfEnemies*calculateAverageDamage(enemy.dice, enemy.bonus, hero.rd, ignoreRD);
                        var hAverageReceivedDamage = calculateAverageDamage(hero.dice, hero.bonus, enemy.rd, ignoreReceivedRD);
    		            enemy.stats[j] = {attack: hAttack, defense: hDefense, averageDamage: hAverageDamage, averageReceivedDamage: hAverageReceivedDamage};
                        
    		            attack += hAttack;
    		            defense += hDefense;
    		            averageDamage += hAverageDamage;
                        averageReceivedDamage += hAverageReceivedDamage;
                    }
                }
                if(count == 0){
                    count = 1;
                }
                enemy.stats.total = {
                    attack: attack / count,
                    defense: defense / count,
                    averageDamage: averageDamage / count,
                    averageReceivedDamage: averageReceivedDamage / count
                };
		    }
		}

		var calculateAverageDamage = function(dice, bonus, rd, ignoreRD){
		    var safeDice = dice || 0;
		    if(safeDice == 0){
		        return 0;
		    }
		    var safeBonus = bonus || 0;
		    var safeRd = !ignoreRD ? rd || 0 : 0;

		    var sum = 0;
		    var damage = safeRd - safeBonus;
		    if( damage < safeDice ) {
		        damage = safeDice;
		    }

		    var chance = chanceMap[damage][safeDice];

		    while(chance > 0){
		        sum += chance*(damage+safeBonus-safeRd);
		        damage++;
		        chance = chanceMap[damage][safeDice];
		    }

		    return sum;
		}

        $scope.$watch('heroes', function(){
            updateStats();
        }, true);

		$scope.$watch('enemies', function(){
		    updateStats();
		}, true);

		$scope.$watch('reduction', function(){
		    updateStats();
		});

        $scope.$watch('ignoreRD', function(){
            updateStats();
        });

		var statsAttack = function(enemy, index){
		    return enemy.stats[index].attack;
		}

		var statsDefense = function(enemy, index){
		    return enemy.stats[index].defense;
        }

        var statsAverageReceivedDamage = function(enemy, index){
            return enemy.stats[index].averageReceivedDamage;
        }

        var statsAverageDamage = function(enemy, index){
            return enemy.stats[index].averageDamage;
        }

		var acumulate = function(target, dice){
		    if(target == null || dice == null || target < 1 || dice < 1){
		        return 0;
		    }
		    if(target > 64 || dice > 9){
		        var msg = 'chance limit excceded: '+target+' '+dice;
		        alert(msg);
		        throw new Error(msg);
		    }
		    var sum = 0;
		    for( var i = 1 ; i <= target ; i++){
		        sum += chanceMap[i-1][dice-1];
		    }
		    return sum;
		};

		var toHit = function(nh, defense){
		    var crit = acumulate(3, 3);
		    var nonCrit = acumulate(nh, 3) - crit;
		    nonCrit = nonCrit > 0? nonCrit : 0;
		    var miss = 1 - acumulate(17, 3);
		    var def = acumulate(defense, 3);
		    var hit = crit-miss+nonCrit*(1-def);
		    return hit > 0 ? hit : 0;
		};

		var calculateClass = function(hero, value){
		    if(hero){
		        if(value < 40){
		            return "red";
		        }
		        if(value < 60){
                    return "yellow";
		        }
		        return "green";
		    }
		    if(value < 40){
                return "green";
            }
            if(value < 60){
                return "yellow";
            }
            return "red";

		}

		var toDamage = function(nh, defense, dice, bonus, rd, ignoreRD){
		    if(dice == null || dice <= 0){
		        return 0;
		    }
		    var safeBonus = bonus || 0;
            var calc = !ignoreRD ? rd - safeBonus : 0;
		    return toHit(nh, defense)*(1-acumulate(calc, dice));
		};

		var exportChar = function(char){
		    return {
		        name: char.name,
		        nh: char.nh,
		        defense: char.defense,
		        dice: char.dice,
		        bonus: char.bonus,
		        rd: char.rd,
                active: char.active,
		    }
		}

		var importEnemy = function(index){
		    var json = prompt("Insira o json:");
		    if(json != null && json != ""){
		        $scope.enemies[index] = JSON.parse(json);
            }
		}

        var importHero = function(index){
            var json = prompt();
            if(json != null && json != ""){
                $scope.heroes[index] = JSON.parse(json);
            }
        }

		var clearEnemy = function(index){
		    $scope.enemies[index] = {};
		}

        var clearHero = function(index){
            $scope.heroes[index] = {};
        }

		var chanceMap =[[0.16666667,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.02777778,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.05555556,0.00462963,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.08333333,0.01388889,0.00077160,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.11111111,0.02777778,0.00308642,0.00012860,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.16666667,0.13888889,0.04629630,0.00771605,0.00064300,0.00002143,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.16666667,0.06944444,0.01543210,0.00192901,0.00012860,0.00000357,0.00000000,0.00000000],
                        [0.00000000,0.13888889,0.09722222,0.02700617,0.00450103,0.00045010,0.00002501,0.00000060,0.00000000],
                        [0.00000000,0.11111111,0.11574074,0.04320988,0.00900206,0.00120027,0.00010002,0.00000476,0.00000010],
                        [0.00000000,0.08333333,0.12500000,0.06172840,0.01620370,0.00270062,0.00030007,0.00002143,0.00000089],
                        [0.00000000,0.05555556,0.12500000,0.08024691,0.02636317,0.00540123,0.00075017,0.00007144,0.00000447],
                        [0.00000000,0.02777778,0.11574074,0.09645062,0.03922325,0.00977366,0.00165038,0.00019647,0.00001637],
                        [0.00000000,0.00000000,0.09722222,0.10802469,0.05401235,0.01620370,0.00327575,0.00047154,0.00004912],
                        [0.00000000,0.00000000,0.06944444,0.11265432,0.06944444,0.02488426,0.00595493,0.00101690,0.00012771],
                        [0.00000000,0.00000000,0.04629630,0.10802469,0.08371914,0.03570816,0.01002729,0.00200522,0.00029709],
                        [0.00000000,0.00000000,0.02777778,0.09645062,0.09452160,0.04816101,0.01577861,0.00365977,0.00063050],
                        [0.00000000,0.00000000,0.01388889,0.08024691,0.10030864,0.06121399,0.02335534,0.00623952,0.00123689],
                        [0.00000000,0.00000000,0.00462963,0.06172840,0.10030864,0.07353824,0.03265746,0.01000705,0.00226490],
                        [0.00000000,0.00000000,0.00000000,0.04320988,0.09452160,0.08371914,0.04328489,0.01517490,0.00390000],
                        [0.00000000,0.00000000,0.00000000,0.02700617,0.08371914,0.09047068,0.05453747,0.02184309,0.00635056],
                        [0.00000000,0.00000000,0.00000000,0.01543210,0.06944444,0.09284979,0.06546854,0.02994018,0.00982159],
                        [0.00000000,0.00000000,0.00000000,0.00771605,0.05401235,0.09047068,0.07499214,0.03918038,0.01447742],
                        [0.00000000,0.00000000,0.00000000,0.00308642,0.03922325,0.08371914,0.08204375,0.04904931,0.02039752],
                        [0.00000000,0.00000000,0.00000000,0.00077160,0.02636317,0.07353824,0.08579461,0.05883071,0.02753248],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.01620370,0.06121399,0.08579461,0.06768690,0.03566976],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00900206,0.04816101,0.08204375,0.07477185,0.04442176],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00450103,0.03570816,0.07499214,0.07935623,0.05324322],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00192901,0.02488426,0.06546854,0.08094350,0.06147923],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00064300,0.01620370,0.05453747,0.07935623,0.06843975],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00012860,0.00977366,0.04328489,0.07477185,0.07349091],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00540123,0.03265746,0.06768690,0.07614776],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00270062,0.02335534,0.05883071,0.07614776],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00120027,0.01577861,0.04904931,0.07349091],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00045010,0.01002729,0.03918038,0.06843975],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00012860,0.00595493,0.02994018,0.06147923],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002143,0.00327575,0.02184309,0.05324322],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00165038,0.01517490,0.04442176],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00075017,0.01000705,0.03566976],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00030007,0.00623952,0.02753248],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00010002,0.00365977,0.02039752],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002501,0.00200522,0.01447742],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000357,0.00101690,0.00982159],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00047154,0.00635056],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00019647,0.00390000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00007144,0.00226490],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00002143,0.00123689],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000476,0.00063050],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000060,0.00029709],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00012771],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00004912],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00001637],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000447],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000089],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000010],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000],
                        [0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000]];

		$scope.test = test;
		$scope.averageDamage  = averageDamage;
		$scope.toHit = toHit;
		$scope.toDamage = toDamage;
		$scope.importEnemy = importEnemy;
		$scope.clearEnemy = clearEnemy;
        $scope.importHero = importHero;
        $scope.clearHero = clearHero;
		$scope.exportChar = exportChar;
		$scope.addEnemy = function(){$scope.enemies.push({})};
        $scope.addHero = function(){$scope.heroes.push({})};
		$scope.removeEnemy = function(index){   $scope.enemies.splice(index, 1)};
        $scope.removeHero = function(index){   $scope.heroes.splice(index, 1)};
		$scope.statsAttack = statsAttack;
		$scope.statsDefense = statsDefense;
		$scope.calculateClass = calculateClass;
		$scope.statsAverageDamage = statsAverageDamage;
        $scope.statsAverageReceivedDamage = statsAverageReceivedDamage;
	}]);
    </script>
</html>